<div id="state-switcher">
  <h3>State switcher</h3>

  <div class="form-group review__table">
    <h4>Build your own</h4>
    <p class="uiToolKitCheckBox">
      <label class="uikit-control-input" for="vp_eligible">
        <input class="uikit-control-input__input" type="checkbox" id="vp_eligible" name="message box">
        <span class="uikit-control-input__text">Veteran Payment eligible</span>
      </label>
    </p>
    <p class="uiToolKitCheckBox">
      <label class="uikit-control-input" for="il_mental_health_being_processed">
        <input class="uikit-control-input__input" type="checkbox" id="il_mental_health_being_processed"
          name="message box">
        <span class="uikit-control-input__text">IL mental health being processed</span>
      </label>
    </p>
    <div class="tr">
      <div class="ss-box">
        <input id="text-input-incomplete" class="uikit-text-input ss" type="text" maxlength="2" name="numWidgets">
      </div>
      <div class="ss-text">Incomplete claims</div>
    </div>
    <div class="tr">
      <div class="ss-box">
        <input id="text-input-tasks" class="uikit-text-input ss" type="text" maxlength="2" name="numWidgets">
      </div>
      <div class="ss-text">Tasks to complete</div>
    </div>
    <div class="tr">
      <div class="ss-box">
        <input id="text-input-transport" class="uikit-text-input ss" type="text" maxlength="2" name="numWidgets">
      </div>
      <div class="ss-text">Transport bookings</div>
    </div>

    <div class="form-group review__table">
      <h4>Overrides</h4>
      <p class="uiToolKitCheckBox">
        <label class="uikit-control-input" for="payment-received">
          <input class="uikit-control-input__input" type="checkbox" id="payment-received" name="numWidgets">
          <span class="uikit-control-input__text">Payment received</span>
        </label>
      </p>
      <p class="uiToolKitCheckBox">
        <label class="uikit-control-input" for="first-login">
          <input class="uikit-control-input__input" id="first-login" type="checkbox" name="first-login">
          <span class="uikit-control-input__text">New profile</span>
        </label>
      </p>
      <p class="uiToolKitCheckBox">
        <label class="uikit-control-input" for="nav-show-cards">
          <input class="uikit-control-input__input" id="nav-show-cards" type="checkbox" name="nav-show-cards">
          <span class="uikit-control-input__text">Show Cards in Navbar</span>
        </label>
      </p>
    </div>
    <%
    locals.el = {};
    locals.el.optionalID = "loading-state";
    locals.el.question = "Loading state:";
    locals.el.items = ["Loaded","Loading full page", "Loading widgets only"];
    %>
    <%- include(partials+"components/form-elements/select") %>
  </div>
</div>

<script>
  function pageLoaded() {
    $('.mys-page-preloader').hide();
    $("main").fadeOut("slow", function () {
      $(this).removeClass("page-loading");
    });
  }

  $(document).ready(function () {
    /* Page preloader CSS */
    setTimeout(pageLoaded, 500);
    /* --- State switcher --- */

    /* Toggle switcher */
    $(document).keypress(function (e) {
      switch (e.which) {
        case 96: //tilda
          $('#state-switcher').toggle();
          break;
        default:
      }
    });

    /* Message */

    var vp_message = sessionStorage.getItem('vp_eligible');
    if (!vp_message) vp_message = false;
    if (vp_message == "true") {
      $("#vp_eligible").prop("checked", true);
    } else {
      $("#vp_eligible").prop("checked", false);
    }

    updateMessageBox();
    $("#vp_eligible").click(function (e) {
      updateMessageBox();
    });

    $("#close-message").click(function (e) {
      closeMessageBox();
    });

    function closeMessageBox() {
      $('#vp_eligible').prop("checked", false);
      updateMessageBox();
    }

    /* VP tile */


    var vp_tile = sessionStorage.getItem('il_mental_health_being_processed');
    if (!vp_tile) vp_tile = false;
    if (vp_tile == "true") {
      $("#il_mental_health_being_processed").prop("checked", true);
    } else {
      $("#il_mental_health_being_processed").prop("checked", false);
    }

    updateVPTile();
    $("#il_mental_health_being_processed").click(function (e) {
      updateVPTile();
    });

    /* Tasks widget */
    var tasks = 3;
    $("#text-input-tasks").val(tasks);
    $("#text-input-tasks").keyup(function () {
      updateTasksWidget();
      updateScenario();
    });

    /* Claims widget */

    var claims_incomplete = sessionStorage.getItem('claims-incomplete');
    if (!claims_incomplete) claims_incomplete = 2;
    $("#text-input-incomplete").val(claims_incomplete);
    $("#text-input-incomplete").keyup(function () {
      updateScenario();
    });

    var claims_submitted = sessionStorage.getItem('claims-submitted');
    if (!claims_submitted) claims_submitted = 3;
    $("#text-input-submitted").val(claims_submitted);
    $("#text-input-submitted").keyup(function () {
      updateScenario();
    });

    /* Payments widget */

    var payments_received = sessionStorage.getItem('payments_received');
    if (!payments_received) payments_received = false;
    $('#payment-received').prop("checked", payments_received);
    $("#payment-received").click(function (e) {
      updateScenario();
    });

    /* Transport widget */

    var transport = sessionStorage.getItem('transport');
    if (!transport) transport = 1;
    $("#text-input-transport").val(transport);
    $("#text-input-transport").keyup(function () {
      updateTransportWidget();
      updateScenario();
    });

    /* First login */

    var first_login = sessionStorage.getItem('first_login');
    if (first_login == null) first_login = false;
    $('#first_login').prop("checked", first_login);
    $("#first-login").click(function (e) {
      updateScenario();
    });

    // loading state
    var loading_state = sessionStorage.getItem('widget_loading_state');
    if (loading_state == null) loading_state = false;
    $("#loading-state").click(function (e) {
      updateScenario();
    });

    /* Scenarios */
    $("#loading-state-list").change(function () {

      var mySelection = $(this).val();

      switch (mySelection) {
        case "Loaded":
          $("main").removeClass('page-loading');
          $(".mys-page-preloader ").hide();
          $("#state-switcher ").hide();
          break;

        case "Loading full page":
          $("main").addClass('page-loading');
          $(".mys-page-preloader").show('fast');
          $("#state-switcher ").hide();

          setTimeout(function () {
            $("main").removeClass('page-loading');
            $(".mys-page-preloader ").hide('fast');
          }, 3000);
          break;

        case "Loading widgets only":
          $("main").removeClass('page-loading');
          $(".mys-page-preloader").hide();
          $("#state-switcher ").hide();
          $(".widget-tile").each(function (index) {
            $(this).addClass("widget-tile--loading");
          });

          var $cards = $('.widget-tile');
          var time = 0;
          setInterval(function () {
            $cards.each(function () {
              var that = this;
              setTimeout(function () {
                $(that).removeClass("widget-tile--loading");
              }, time)
              time += 500;
            });
          }, 4000);
          break;
      }
    });

    /* --- End State switcher --- */

    /* Greeting */

    function updateGreeting() {
      var myDate = new Date();
      var hrs = myDate.getHours();
      var greet;
      if (hrs < 12)
        greet = 'Good morning';
      else if (hrs >= 12 && hrs <= 17)
        greet = 'Good afternoon';
      else if (hrs >= 17 && hrs <= 24)
        greet = 'Good evening';
      document.getElementById('lblGreetings').innerHTML = greet;
    }

    /* message box */

    function updateMessageBox() {

      if ($("#vp_eligible").prop("checked") == true) {
        sessionStorage.setItem('vp_eligible', true);
        sessionStorage.setItem('first_login', false);

        $("#first-login").prop("checked", false);
        $("#welcome-message").hide();
        $("#message-box-veteran-payment").show();
        $("#il_mental_health_being_processed").prop("checked", true);
        updateVPTile();
      } else {
        sessionStorage.setItem('vp_eligible', false);
        $("#il_mental_health_being_processed").prop("checked", false);
        updateVPTile();
        $("#message-box-veteran-payment").hide();
      }
      updateScenario();
    }

    /* message box */

    function updateVPTile() {
      if ($("#il_mental_health_being_processed").prop("checked") == true) {
        sessionStorage.setItem('il_mental_health_being_processed', true);
        $("#vp").show();
      } else {
        sessionStorage.setItem('il_mental_health_being_processed', false);
        $("#vp").hide();
      }
    }

    /* First login */

    function updateFirstLogin() {
      if ($("#first-login").prop("checked") == true) {
        hideAll();
        $(".first-login-hidden").hide();
        $("#message-box-veteran-payment").hide();
        $("#welcome-message").show();
        $("#vp_eligible").prop("checked", false);
        sessionStorage.setItem('vp_eligible', false);
        sessionStorage.setItem('first_login', true);
      } else {
        $(".first-login-hidden").show();
        $("#welcome-message").hide();
        sessionStorage.setItem('first_login', false);
      }
    }

    function updateLoadingState() {
      if ($("#loading-state").prop("checked") == true) {
        $(".widget-tile").each(function (index) {
          $(this).addClass("widget-tile--loading");
        });
        sessionStorage.setItem('widget_loading_state', true);
      } else {
        $(".widget-tile").each(function (index) {
          $(this).removeClass("widget-tile--loading");
        });
        sessionStorage.setItem('widget_loading_state', false);
      }
    }

    /* Update everything */

    function updateScenario() {
      // updateVisibleWidgets();
      updateGreeting();
      updateTasksWidget();
      updateClaimsWidget();
      updatePaymentsWidget();
      updateTransportWidget();

      /* Over ride for first login */
      updateLoadingState();
      updateFirstLogin();
    }

    /* Init */

    updateScenario();
    $(".tablet-hide").hide("fast");

    function hideAll() {
      $("#widget-tasks").hide();
      $("#widget-claims").hide();
      $("#widget-payments").hide();
      $("#widget-profile").hide();
      $("#widget-transport").hide();
      $("#welcome-message").hide();
      $("#profile-message").hide();
    }

    function hideAllClaims() {
      $("#il").hide();
      $("#mental-health").hide();
      $("#covenant").hide();
      $("#incap").hide();
      $("#increase-disability").hide();
      $("#education").hide();
      $("#qs").hide();
      $("#civilian-qs").hide();
      $("#service-pension").hide();
      $("#partner-pension").hide();
      $("#lump-sum").hide();
      $("#representation").hide();
      $("#dhoas").hide();
      $("#insurance").hide();
    }

    /* Layout */

    // $(window).resize(function () {
    //   updateVisibleWidgets();
    // });

    //   function updateVisibleWidgets() {

    //     // interim solution to hide the tasks widget on devices below 991px
    //     if ($(window).width() > 991) {
    //       if (sessionStorage.getItem("first-login") == false && sessionStorage.getItem('tasks') > 0) {
    //         $("#widget-tasks").show();
    //       }
    //     } else {
    //       $("#widget-tasks").hide();
    //     }
    //   }
  });



  //helper function to capitalize the first letter in a string

  function jsUcfirst(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

  $(document).ready(function () {

    const person = JSON.parse(localStorage.getItem("person"));

    if (person.cards && person.cards.length > 0) {
      $("#nav-show-cards").prop("checked", true);
    }

    $("#nav-show-cards").on("change", function () {
      if ($(this).prop("checked")) {
        $("#healthcard").show();
      } else {
        $("#healthcard").hide();
      }
    });
  });

  //functions for updating text within each widget and controlling their display
  function updateTasksWidget() {
    var tasks = $("#text-input-tasks").val();
    sessionStorage.setItem('tasks', tasks);
    $("#widget-tasks .dashboard-widget__number").text(tasks);
    if (tasks == 1) $("#tasks-text").text('Task to complete');
    if (tasks > 0) {
      $("#widget-tasks").show("fast");
      $("#task_text").show();
    } else {
      $("#widget-tasks").hide("fast");
      $("#task_text").hide();
    }
    if (tasks == 0) {
      console.log("tasks is 0");
      $("#tasks").hide();
    }
    else {
      $("#tasks").show();
    }
  }

  function updateTransportWidget() {
    var bookings = $("#text-input-transport").val();
    sessionStorage.setItem('bookings', tasks);
    $("#widget-transport .dashboard-widget__number").text(bookings);
    if (bookings > 0) {
      $("#widget-transport").show("fast");
    } else {
      $("#widget-transport").hide("fast");
    }
  }

  function updatePaymentsWidget() {
    if ($('#payment-received').prop("checked") == true) {
      $("#widget-payments").show("fast");
      $("#payments").show();
      sessionStorage.setItem('payments_received', true);
    } else {
      $("#widget-payments").hide("fast");
      $("#payments").hide();
      sessionStorage.setItem('payments_received', false);
    }
  }

  function updateClaimsWidget() {
    var incomplete = $("#text-input-incomplete").val();
    $("#widget-claims .dashboard-widget__number").html(incomplete);
    sessionStorage.setItem('claims-incomplete', incomplete);
    var submitted = $("#text-input-submitted").val();
    $("#text-reflect-submitted").html(submitted);
    sessionStorage.setItem('claims-submitted', submitted);
    // if (incomplete > 0) {
    //   $("#claims-incomplete").css('display', 'flex');
    // } else {
    //   $("#claims-incomplete").hide();
    // }
    // if (submitted > 0) {
    //   $("#claims-submitted").css('display', 'flex');
    // } else {
    //   $("#claims-submitted").hide();
    // }
    if (incomplete > 0 || submitted > 0) {
      $("#widget-claims").show("fast");
    } else {
      $("#widget-claims").hide("fast");
    }
    if (incomplete == 0 && submitted == 0) {
      $("#claim").hide();
    } else {
      $("#claim").show();
    }
  }

</script>