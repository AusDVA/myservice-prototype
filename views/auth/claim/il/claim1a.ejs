<!DOCTYPE html>
<html class="js" lang="en">

<head>
  <title>Add claim: Diagnosis | MyService</title>
  <%- include(partials+"components/layout/head") %>

  <style>
    .pt-required-docs,
    .pt-no-required-docs,
    .pt-upload-list,
    .pt-upload-list-optional,
    .pt-upload-other-docs,
    .pt-medical-prac {
      display: none;
    }

  </style>

</head>

<body class="uikit-body uikit-grid uikit-refactor">
  <noscript>
    <p role="alert">This website needs JavaScript to work properly.</p>
  </noscript>
  <nav class="uikit-skip-link">
    <a class="uikit-skip-link__link" href="#main-content">Skip to main content</a>
  </nav>
  <%- include(partials+"components/layout/header-topbar") %>
  <%- include(partials+"components/layout/header-claims") %>
  <%- include(partials+"components/layout/header-nom-rep") %>



  <main>
    <div class="container" id="main-content">
      <div id="progressbar">
        <div id="percentage">
          <p id="percentage_value"></p>
        </div>

      </div>
      <h1>Medical Provider</span>
      </h1>

      <div id="medical-practitioner-group" class="form-group">
          <div class="form-group">
              <label class="uikit-text-input__label" for="practitioners">Select the medical practitioner that provided the diagnosis</label>
              <div id="medical-practitioner">
                  <p class="uiToolKitCheckBox">
                      <label class="uikit-control-input">
                          <input class="uikit-control-input__input" type="radio" name="practitioners" value="none">
                          <span class="uikit-control-input__text">None of the above</span>
                      </label>
                  </p>
              </div>
          </div>
      </div>
      <div class="pt-medical-prac">
          <%- include(partials+"content/medical-practitioner.ejs", {"lastSixMonths": false});%>
      </div>

      <div id="save-next" hidden>
        <p>Choose <b>save and next</b> to continue</p>
      </div>


      <div class=" pagination">
        <button class="uikit-btn uikit-btn--tertiary" onclick="window.location.href = '/auth/claim'">Previous</button>
        <button class="uikit-btn uikit-btn--tertiary" onclick="window.location.href = '#open-modal'">Cancel claim</button>
        <div class="floated">
          <button class="uikit-btn uikit-btn--tertiary" onclick="window.location.href = '/auth/claim/'">Save and exit</button><button class="uikit-btn btnNext"
            onclick="window.location.href = '/auth/claim/il/claim1b'">Save and next</button>
        </div>
      </div>


      <%- include(partials+"content/modals/claims-cancel-modal") %>

      <%- include(partials+"content/modals/claims-removefile-modal") %>

    </div>
  </main>

  <%- include(partials+"components/layout/footer") %>



  <script src="/docs/js/jquery-ui.min.js"></script>

  <script src="/docs/js/claims.js"></script>

  <script>

    var practs = [];

    $.ajax({
      url: '/docs/data/medical-practitioner.json',
      type: 'GET',
      dataType: 'json'
    })
    .done((data) => {
        person = JSON.parse(localStorage.getItem("person"));
        $.each(data.practitioners, (index, pract) => {
          if (person.practitioners.includes(pract._id)) {
            practs.push({
              id: pract._id,
              name: pract.nameFull,
              type: pract.type,
              nameFull: pract.nameFull,
              practiceName: pract.practiceName,
              practiceSuburb: pract.practiceSuburb,
              practiceState: pract.practiceState,
              practicePhone: pract.practicePhone
            });
          }
        });

        if (practs.length < 1) {
          $("#medical-practitioner-group").hide("fast");
          $(".pt-medical-prac").show("fast");
        } else {
          $.each(practs, (index, pract) => {
            $("#medical-practitioner").prepend(`
                  <p class="uiToolKitCheckBox">
                      <label class="uikit-control-input">
                          <input value="${pract.id}" class="uikit-control-input__input" type="radio" name="practitioners">
                          <span class="uikit-control-input__text">${pract.name}</span>
                      </label>
                  </p>`);
          });
        }

        $("#medical-practitioner").on("change", "input", () => {
          $("#save-next").hide("fast");
          if ($("#medical-practitioner :checked").val() === "none") {
            $(".pt-medical-prac").data("type", "adding");
            $("#practitioner-type :first-child").prop("selected", true)
            $("#drName").val("");
            $("#practiceName").val("");
            $("#practiceSuburb").val("");
            $("#practiceSuburb").val("");
            $("#state-location :first-child").prop("selected", true)
            $("#gp-number").val("");
            $("#correctDetails").hide("fast");
            $("#updateDetails").hide("fast");
            $("#addPractitioner").show("fast");
            $("#hint-adding").show("fast");
            $("#hint-reviewing").hide("fast");
            $(".pt-medical-prac").show("fast");
          } else {
            sel_prac = $("#medical-practitioner :checked").val();
            $.each(practs, (index, pract) => {
              if (pract.id === sel_prac) {
                $(".pt-medical-prac").show("fast");
                $("#updateDetails").hide("fast");
                $("#addPractitioner").hide("fast");
                $("#correctDetails").show("fast");
                $("#hint-reviewing").show("fast");
                $("#hint-adding").hide("fast");
                $("#practitioner-type option").each(function(index, elem) {
                  if($(this).text() == pract.type) {
                    $(this).prop("selected", true);
                  }
                });
                $("#drName").val(pract.nameFull);
                $("#drName").data("initial-val", pract.nameFull);
                $("#practiceName").val(pract.practiceName);
                $("#practiceSuburb").val(pract.practiceSuburb);
                $("#state-location option").each(function(index, elem) {
                  if ($(this).val() == pract.practiceState) {
                    $(this).prop("selected", true)
                  }
                });
                $("#gp-number").val(pract.practicePhone);
              }
            });
            $(".pt-medical-prac").attr("data-type", "reviewing");
          }
        });

        $(".pt-medical-prac").on("change", "input, select", () => {
          if ($(".pt-medical-prac").data("type") === "reviewing") {
            $("#updateDetails").show("fast");
            $("#correctDetails").hide("fast");
            $("#addPractitioner").hide("fast");
            $(".pt-medical-prac").data("type", "reviewed");
          }
        });

        $("#correctDetails").on("click", () => {
          $(".pt-medical-prac").hide("fast");
          $("#save-next").show("fast");
        });

        $("#updateDetails").on("click", () => {
          $(".pt-medical-prac").hide("fast");
          $("#save-next").show("fast");
          if ($("#drName").val() != $("#drName").data("initial-val")) {
            $("#medical-practitioner input").each(function() {
              console.log($(this));
              // console.log("initial: " + $("#drName").data("initial-val"));
              // console.log("opt txt: " + opt.text());
              if ($(this).parent().find("span").text() == $("#drName").data("initial-val")) {
                $(this).parent().find("span").text($("#drName").val());
              }
            });
          }
        });

        $("#addPractitioner").on("click", () => {
          if ($("#drName").val() != "") {
            $("#drName").parent().removeClass("has-error");
            $("#drName").parent().find("label").html("Doctor's Name");
            var doc_id = Math.floor(Math.random() * 10000);
            $("#medical-practitioner").append(`
                  <p class="uiToolKitCheckBox">
                      <label class="uikit-control-input">
                          <input value="${doc_id}" class="uikit-control-input__input" type="radio" name="practitioners">
                          <span class="uikit-control-input__text">${$("#drName").val()}</span>
                      </label>
                  </p>`);
            $(".pt-medical-prac").hide("fast");
            $("#medical-practitioner-group").show();
            $("#medical-practitioner input:last-of-type").prop("checked", true);
            person.practitioners.push(doc_id.toString());
            localStorage.setItem("person", JSON.stringify(person));
            $("#save-next").show("fast");
          } else {
            $("#drName").parent().addClass("has-error");
            $("#drName").parent().find("label").html(`Doctor's name <span class="input-error-message">Please enter your doctor's name</span>`);
          }
        });
    });


  </script>
</body>

</html>
